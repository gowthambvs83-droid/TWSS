<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TWSS - Courses & Daily Downloads</title>

  <!-- Razorpay + Supabase clients -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --accent:#CD5C5C;
      --primary:#232f3e;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      font-family:Inter,system-ui,Arial,Helvetica,sans-serif;
      margin:0;background:#fbfbfb;color:var(--primary);
      -webkit-font-smoothing:antialiased;
    }
    header{
      background:linear-gradient(90deg,#8B4513,#CD5C5C);
      color:#fff;padding:1.25rem 1rem;text-align:center;
      box-shadow:0 6px 20px rgba(0,0,0,0.06);
    }
    .container{max-width:1100px;margin:2rem auto;padding:0 1rem}
    h1,h2{margin:0}
    .grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:1.25rem;margin-top:1rem;
    }
    .card{
      background:#fff;padding:1.25rem;border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    .unit-header{font-weight:700;margin-bottom:.5rem}
    .price{font-size:1.05rem;font-weight:700;color:var(--accent);margin:0.6rem 0}
    .btn{display:inline-block;padding:.6rem .9rem;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn-buy{background:#28a745;color:#fff}
    .btn-download{background:var(--accent);color:#fff}
    .coupon-input{width:100%;padding:.6rem;border-radius:8px;border:1px solid #e6e6e6;margin-top:.5rem}
    .muted{color:var(--muted);font-size:.95rem}
    .success{background:#d4edda;color:#155724;padding:.6rem;border-radius:8px;margin-top:.8rem}
    .error{background:#f8d7da;color:#721c24;padding:.6rem;border-radius:8px;margin-top:.8rem}
    footer{padding:2rem;text-align:center;color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
  <header>
    <h1>TWSS — Courses & Daily Downloads</h1>
    <p class="muted">Buy courses or pay for daily downloads. After payment, you will be redirected to a one-time-access link.</p>
  </header>

  <div class="container">
    <section>
      <h2>All Courses (Products)</h2>
      <div class="grid units-grid">
        <!-- Products injected by JS -->
      </div>
    </section>

    <section style="margin-top:2rem;">
      <h2>Daily Downloads (One-time links)</h2>
      <div class="grid download-grid">
        <!-- Download cards injected by JS -->
      </div>
    </section>
  </div>

  <footer>© 2025 TWSS. All rights reserved.</footer>

<script>
/* --------------------------
   CONFIG - replace these
   -------------------------- */
const RAZORPAY_KEY_ID = "rzp_live_iwzig23hBqUD90"; // <-- replace
const SUPABASE_URL = "https://fzwvxesrtdilljgrntpw.supabase.co";       // <-- replace (e.g. https://xyz.supabase.co)
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6d3Z4ZXNydGRpbGxqZ3JudHB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NzU2NzMsImV4cCI6MjA2NjQ1MTY3M30.YnxjUtFawuumihyVGuk8e-o6iE9OkDf-MX1aKRTqA5U"; // <-- replace
const ACCESS_TABLE = "paid_access";
const USERS_TABLE = "users_login";
/* -------------------------- */

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ======= PRODUCTS (all courses you mentioned) =======
   I used the product list you provided earlier: c_notes, cpp_notes, java_notes,
   python_notes, sql_notes, dsa_analytics, dsa_fullstack. Add or edit entries here.
*/
const products = [
  { id: "c_notes", name: "C Language Notes", price: 900, details: ["C NOTES (HAND WRITTEN)","C E-NOTES"], link: "https://t.me/your_C_language_channel" },
  { id: "cpp_notes", name: "C++ Language Notes", price: 900, details: ["C++ NOTES (HAND WRITTEN)","C++ E-NOTES"], link: "https://t.me/+YZAEiLCzEDkwNjdl" },
  { id: "java_notes", name: "JAVA Language Notes", price: 900, details: ["JAVA NOTES (HAND WRITTEN)","JAVA E-NOTES"], link: "https://t.me/your_JAVA_language_channel" },
  { id: "python_notes", name: "Python Language Notes", price: 900, details: ["PYTHON NOTES (HAND WRITTEN)","PYTHON E-NOTES"], link: "https://t.me/your_PYTHON_language_channel" },
  { id: "sql_notes", name: "SQL Language Notes", price: 900, details: ["SQL NOTES (HAND WRITTEN)","SQL E-NOTES"], link: "https://t.me/your_SQL_language_channel" },
  { id: "dsa_analytics", name: "DSA + Data Analytics Plan", price: 15900, details: ["ROADMAP","DSA NOTES","COMPANY CHEAT SHEET"], link: "https://t.me/your_DSA_Analytics_channel" },
  { id: "dsa_fullstack", name: "DSA + Full-Stack Plan", price: 14900, details: ["ROADMAP","DSA NOTES","COMPANY CHEAT SHEET"], link: "https://t.me/your_DSA_FullStack_channel" }
];

/* ======= DOWNLOAD ITEMS (daily) ======= */
const downloads = [
  { day: "daybeforebeforeyesterday", title: "Day Before Before Yesterday", price: 4900, file: "/downloads/daybeforebeforeyesterday.pdf", redirectPage: "/daybeforebeforeyesterday.html" },
  { day: "daybeforeyesterday", title: "Day Before Yesterday", price: 4900, file: "/downloads/daybeforeyesterday.pdf", redirectPage: "/daybeforeyesterday.html" },
  { day: "yesterday", title: "Yesterday", price: 4900, file: "/downloads/yesterday.pdf", redirectPage: "/yesterdaydl.html" }
];

/* Coupons */
const validCoupon = { code: "SAVE1", discount: 800 }; // in paisa
const ownerCoupon = "FREE";

/* ---------- Helpers ---------- */
function formatRsFromPaisa(p) {
  return (p/100).toFixed(2);
}
function genRandomCredentials() {
  // generate uid and pass (one-time). Using twss.com domain to avoid exposing Gmail.
  const uid = `user${Date.now()}${Math.floor(Math.random()*1000)}@twss.com`;
  const pass = Math.random().toString(36).slice(-10);
  return { uid, pass };
}

/* ---------- Render UI ---------- */
function renderProducts() {
  const container = document.querySelector('.units-grid');
  container.innerHTML = '';
  products.forEach(prod => {
    const div = document.createElement('div');
    div.className = 'card unit-card';
    div.setAttribute('data-product-id', prod.id);
    const detailsHtml = prod.details.map(d => `<li class="muted">• ${d}</li>`).join('');
    div.innerHTML = `
      <div class="unit-header">${prod.name}</div>
      <div class="muted">${prod.details.length} items</div>
      <div class="price">₹ ${formatRsFromPaisa(prod.price)}</div>
      <ul style="margin-top:.5rem">${detailsHtml}</ul>
      <div style="margin-top:.9rem">
        <input class="coupon-input" placeholder="Coupon (optional)" />
      </div>
      <div style="margin-top:.8rem">
        <button class="btn btn-buy">Buy for ₹${formatRsFromPaisa(prod.price)}</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function renderDownloads() {
  const container = document.querySelector('.download-grid');
  container.innerHTML = '';
  downloads.forEach(d => {
    const div = document.createElement('div');
    div.className = 'card download-card';
    div.setAttribute('data-day', d.day);
    div.innerHTML = `
      <div class="unit-header">${d.title}</div>
      <div class="muted">One-time access link will be generated after payment</div>
      <div class="price">₹ ${formatRsFromPaisa(d.price)}</div>
      <div style="margin-top:.6rem"><input class="coupon-input" placeholder="Coupon (optional)"></div>
      <div style="margin-top:.8rem"><button class="btn btn-download">Pay & Get Link</button></div>
    `;
    container.appendChild(div);
  });
}

/* ---------- Payment handlers ---------- */
async function handleBuyUnit(card, product, button) {
  // Standard product buy — simply open Razorpay and after success show redirect link (product.link)
  const couponInput = card.querySelector('.coupon-input');
  const coupon = couponInput ? couponInput.value.trim().toUpperCase() : '';
  let finalAmount = product.price;

  // apply coupon
  if (coupon) {
    if (coupon === validCoupon.code) {
      finalAmount = Math.max(100, product.price - validCoupon.discount);
    } else if (coupon === ownerCoupon) {
      finalAmount = 100;
    } else {
      alert('Invalid coupon');
      return;
    }
  }

  const originalText = button.innerHTML;
  button.disabled = true;
  button.innerHTML = 'Processing...';

  const options = {
    key: RAZORPAY_KEY_ID,
    amount: finalAmount,
    currency: "INR",
    name: "TWSS",
    description: product.name,
    handler: function (response) {
      // Payment succeeded — show a small success UI: transform card content to success + link
      card.innerHTML = `
        <div class="unit-header">Payment Successful!</div>
        <div class="muted" style="margin-top:.6rem">Thank you. Click below to access your course content.</div>
        <div style="margin-top:.9rem">
          <a class="btn btn-buy" href="${product.link}" target="_blank">Open Course / Channel</a>
        </div>
      `;
    },
    modal: {
      ondismiss: () => {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    },
    theme: { color: "#CD5C5C" }
  };

  const rzp = new Razorpay(options);
  rzp.on('payment.failed', function(resp){
    alert("Payment failed: " + (resp.error && resp.error.description ? resp.error.description : "Unknown"));
    button.disabled = false;
    button.innerHTML = originalText;
  });
  rzp.open();
}

async function handleDownload(card, downloadItem, button) {
  const couponInput = card.querySelector('.coupon-input');
  const coupon = couponInput ? couponInput.value.trim().toUpperCase() : '';
  let finalAmount = downloadItem.price;

  // apply coupon handling
  if (coupon) {
    if (coupon === validCoupon.code) {
      finalAmount = Math.max(100, downloadItem.price - validCoupon.discount);
    } else if (coupon === ownerCoupon) {
      finalAmount = 100;
    } else {
      alert('Invalid coupon');
      return;
    }
  }

  const originalText = button.innerHTML;
  button.disabled = true;
  button.innerHTML = 'Processing...';

  const options = {
    key: RAZORPAY_KEY_ID,
    amount: finalAmount,
    currency: "INR",
    name: "TWSS",
    description: `Download: ${downloadItem.title}`,
    notes: { day: downloadItem.day },
    handler: async function (response) {
      // Payment success: generate random uid/pass, insert into paid_access, then redirect to appropriate page with query
      try {
        const { uid, pass } = genRandomCredentials();

        // Insert into Supabase paid_access with used=false
        const insertPayload = { uid: uid, password: pass, used: false, created_at: new Date().toISOString(), day: downloadItem.day };
        const { error: insertErr } = await supabaseClient
          .from(ACCESS_TABLE)
          .insert([insertPayload]);

        if (insertErr) {
          console.error("Supabase insert error", insertErr);
          alert("Payment succeeded but we couldn't create your download link. Contact support.");
          // restore button
          button.disabled = false;
          button.innerHTML = originalText;
          return;
        }

        // Build redirect page: ensure full origin path that matches your site
        // Use the values in downloads[].redirectPage
        const base = downloadItem.redirectPage || "/sample";
        // ensure absolute URL on your Netlify domain
        const origin = window.location.origin.includes('netlify') ? window.location.origin : "https://twss.netlify.app";
        // If redirectPage already has leading slash and is hosted on twss, build it
        const redirectBase = (downloadItem.redirectPage && downloadItem.redirectPage.startsWith('http')) ? downloadItem.redirectPage : (origin + (downloadItem.redirectPage.startsWith('/') ? downloadItem.redirectPage : '/' + downloadItem.redirectPage));

        const redirectUrl = `${redirectBase}?uid=${encodeURIComponent(uid)}&pass=${encodeURIComponent(pass)}`;
        // go to the page that consumes the link (page should mark used=true)
        window.location.href = redirectUrl;

      } catch (err) {
        console.error("Unexpected after-payment error:", err);
        alert("Payment succeeded but an error occurred. Contact support.");
        button.disabled = false;
        button.innerHTML = originalText;
      }
    },
    modal: {
      ondismiss: () => {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    },
    prefill: { name: "", email: "", contact: "" },
    theme: { color: "#CD5C5C" }
  };

  const rzp = new Razorpay(options);
  rzp.on('payment.failed', (res) => {
    alert("Payment failed: " + (res.error && res.error.description ? res.error.description : "Unknown"));
    button.disabled = false;
    button.innerHTML = originalText;
  });
  rzp.open();
}

/* ---------- wire up after render ---------- */
function wireUpHandlers() {
  // product buy handlers
  document.querySelectorAll('.unit-card').forEach(card => {
    const btn = card.querySelector('.btn-buy');
    const id = card.getAttribute('data-product-id');
    const product = products.find(p => p.id === id);
    btn.addEventListener('click', () => handleBuyUnit(card, product, btn));
  });

  // download handlers
  document.querySelectorAll('.download-card').forEach(card => {
    const btn = card.querySelector('.btn-download');
    const day = card.getAttribute('data-day');
    const downloadItem = downloads.find(d => d.day === day);
    btn.addEventListener('click', () => handleDownload(card, downloadItem, btn));
  });
}

/* ---------- init ---------- */
function init() {
  renderProducts();
  renderDownloads();
  // small timeout to ensure nodes exist
  setTimeout(wireUpHandlers, 50);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
