<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EmailJS OTP debug — TWSS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Use the official CDN for EmailJS and Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f3f6fb;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
    .card{width:760px;max-width:95%;background:#fff;padding:22px;border-radius:12px;box-shadow:0 10px 30px rgba(20,30,60,.08)}
    h2{margin:0 0 8px}
    .row{display:flex;gap:8px}
    input{flex:1;padding:10px;border-radius:8px;border:1px solid #dfe6f0}
    button{padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
    .ghost{background:#eef2ff;color:#0f172a}
    .status{margin:12px 0;font-weight:700}
    .status.error{color:#b91c1c}
    .status.success{color:#15803d}
    pre.debug{height:160px;overflow:auto;background:#0b1220;color:#cbd5e1;padding:12px;border-radius:8px;margin-top:12px;font-size:13px}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <div class="card">
    <h2>TWSS — Send OTP (EmailJS) — Debug</h2>
    <p class="muted">Make sure your EmailJS template contains variables <strong>{{email}}</strong>, <strong>{{passcode}}</strong>, <strong>{{time}}</strong> and that your page origin is added to EmailJS allowed origins.</p>

    <div class="status" id="status">Ready</div>

    <div style="margin-top:8px">
      <label class="muted">Email to send OTP to</label>
      <div class="row" style="margin-top:6px">
        <input id="emailInput" type="email" placeholder="student@college.edu" />
        <button id="sendBtn">Send OTP</button>
        <button id="testBtn" class="ghost">Quick Test</button>
      </div>
      <div style="margin-top:8px" class="muted">Status messages appear above. Full logs appear below.</div>
    </div>

    <pre id="debug" class="debug"></pre>
  </div>

<script>
/* ====== CONFIG - replace if you want ====== */
const EMAILJS_PUBLIC_KEY  = "Kvw3qwiz3bt3Xutlf";   // from your screenshot (Public Key)
const EMAILJS_SERVICE_ID  = "service_o3hfoip";      // your service id
const EMAILJS_TEMPLATE_ID = "template_0lscxdn";     // your template id

/* ====== INIT libs ====== */
const debugEl = document.getElementById('debug');
function log(...args){ console.log(...args); debugEl.textContent += args.map(a=> (typeof a==="object"?JSON.stringify(a,null,2):String(a)) ).join(' ') + "\n"; debugEl.scrollTop = debugEl.scrollHeight; }
function setStatus(msg, type=''){ const s = document.getElementById('status'); s.textContent = msg; s.className = type ? `status ${type}` : 'status'; log("STATUS:", msg); }

if(typeof emailjs === "undefined"){ setStatus("EmailJS lib not loaded (check CDN).", "error"); log("emailjs is undefined"); } 
else {
  try {
    // emailjs.init is recommended
    emailjs.init(EMAILJS_PUBLIC_KEY);
    log("emailjs.init called with public key (will also pass publicKey on send as fallback).");
  } catch(e){ log("emailjs.init error:", e); }
}

/* ===== helpers ===== */
function makeOtp(){ return String(Math.floor(100000 + Math.random()*900000)); }
function isEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }

/* ===== Send OTP function with lots of debug info ===== */
async function sendOtpTo(email){
  if(!isEmail(email)){ setStatus("Enter a valid email.", "error"); return; }

  const otp = makeOtp();
  const expiry = new Date(Date.now() + 15*60*1000).toLocaleString();

  setStatus("Attempting to send OTP to " + email + " ...");

  // Template parameters: must match exactly the variable names used in EmailJS template
  const templateParams = {
    email: email,        // matches {{email}} in template
    passcode: otp,       // matches {{passcode}} in template
    time: expiry         // matches {{time}} in template
  };

  log("Template params:", templateParams);

  // Try sending — call with publicKey as 4th argument as extra compatibility
  try {
    if(typeof emailjs === "undefined"){
      throw new Error("EmailJS client not loaded.");
    }

    // Two ways: (1) if init used, this should work; (2) pass public key as fourth argument (works even if init fails)
    // Using await so we can log the full response / error
    const resp = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams, EMAILJS_PUBLIC_KEY);
    setStatus("OTP sent successfully. Check inbox/spam.", "success");
    log("EmailJS success response:", resp);
    // show the OTP as debug so you can confirm matching template param (REMOVE in production)
    log("DEBUG OTP (remove before prod):", otp, "expires:", expiry);
  } catch(err) {
    setStatus("Failed to send OTP — see debug below.", "error");
    // EmailJS error objects often contain .status and .text or .message
    log("EmailJS send failed:", err);
    if(err && err.text) log("err.text:", err.text);
    if(err && err.status) log("err.status:", err.status);
    if(err && err.message) log("err.message:", err.message);
    // common specific hints:
    log("HINTS: If you see 'Origin not allowed' -> add your page origin to EmailJS allowed domains. If you see 'template is missing variable' -> update template variable names to {{email}}, {{passcode}}, {{time}}");
  }
}

/* ===== UI wiring ===== */
document.getElementById('sendBtn').addEventListener('click', ()=>{
  const email = document.getElementById('emailInput').value.trim().toLowerCase();
  sendOtpTo(email);
});

// Quick test sends to value in input or to your own email if blank
document.getElementById('testBtn').addEventListener('click', ()=>{
  const value = document.getElementById('emailInput').value.trim();
  const testEmail = value || prompt("Enter email to test (your email):");
  if(testEmail) sendOtpTo(testEmail);
});

/* ===== initial message ===== */
setStatus("Ready — enter email and press Send. Open DevTools console for more info.");
log("CONFIG:", { EMAILJS_PUBLIC_KEY, EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID });
</script>
</body>
</html>
