<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TWSS â€” Secure Duty Leave Download</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- external libs -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --text:#0f172a; --muted:#6b7280;
      --error:#dc2626; --success:#16a34a; --primary:#2563eb; --accent:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,#eef2ff 0%,#f4f6f8 60%);}
    .card{width:min(640px,94%);background:var(--card);border-radius:14px;padding:26px;
      box-shadow:0 20px 45px rgba(0,0,0,.08);position:relative}
    h1{margin:0;font-size:1.3rem}
    .sub{color:var(--muted);margin:.35rem 0 1rem}
    .status{font-weight:700;margin:.5rem 0}
    .status.error{color:var(--error)}
    .status.success{color:var(--success)}
    .row{display:flex;gap:10px;align-items:center}
    input[type="email"],input[type="text"]{
      width:100%;padding:.78rem;border:1px solid #e6e9ef;border-radius:10px;font-size:1rem;
    }
    input:focus{outline:none;box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    button{border:0;border-radius:10px;padding:.7rem 1rem;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    button.ghost{background:#eef2ff;color:#0f172a;border:1px solid #e5e7eb}
    .muted{color:var(--muted);font-size:.92rem}
    .otp-box,.dl{display:none;margin-top:14px}
    .download-btn{display:inline-block;background:var(--accent);color:#fff;padding:.9rem 1.25rem;border-radius:12px;text-decoration:none;font-weight:800}
    .fine{font-size:.85rem;color:var(--muted);margin-top:.5rem}
    .debug{font-family:monospace;background:#0f172a;color:#fff;padding:.5rem;border-radius:8px;margin-top:12px;white-space:pre-wrap;display:none}
  </style>
</head>
<body>
  <main class="card" id="app">
    <h1>Duty Leave â€” Secure Download</h1>
    <p class="sub">Enter your email (used for purchase). We'll send a One-Time Password (OTP) â€” verify it to unlock the download.</p>

    <div id="status" class="status"></div>

    <!-- email input -->
    <div id="emailStep">
      <label class="muted">Your email</label>
      <div class="row" style="margin-top:.5rem">
        <input id="emailInput" type="email" placeholder="name@college.edu" autocomplete="email" />
        <button id="sendOtpBtn">Send OTP</button>
      </div>
      <div class="fine">Tip: use the same email you used to buy the duty leave.</div>
    </div>

    <!-- OTP area -->
    <div id="otpStep" class="otp-box">
      <hr style="margin:16px 0;border:none;border-top:1px solid #eef2ff">
      <label class="muted">Enter the 6-digit OTP sent to your email</label>
      <div class="row" style="margin-top:.5rem">
        <input id="otpInput" inputmode="numeric" maxlength="6" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
        <button id="verifyOtpBtn">Verify OTP</button>
        <button id="resendBtn" class="ghost" disabled title="Resend OTP">Resend (30s)</button>
      </div>
      <div id="otpMsg" class="fine"></div>
    </div>

    <!-- Download -->
    <div id="downloadStep" class="dl">
      <hr style="margin:16px 0;border:none;border-top:1px solid #eef2ff">
      <h3 style="margin:.2rem 0">âœ… OTP verified</h3>
      <p class="muted">Download below. After download, this token will be marked used.</p>
      <a id="downloadLink" class="download-btn" href="/Screenshot 2025-08-27 005537.png" download>Download Duty Leave</a>
      <div class="fine">If the file doesn't start, right-click â†’ Save link as...</div>
    </div>

    <!-- Visible only while debugging (toggleable) -->
    <pre id="debug" class="debug"></pre>
  </main>

<script>
/* ============================
   CONFIG â€” edit if needed
   ============================ */
const DEBUG = false; // set true to show debug box on screen
const DOWNLOAD_FILE = "/Screenshot 2025-08-27 005537.png"; // change to your actual file path

// Supabase
const SUPABASE_URL  = "https://fzwvxesrtdilljgrntpw.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6d3Z4ZXNydGRpbGxqZ3JudHB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NzU2NzMsImV4cCI6MjA2NjQ1MTY3M30.YnxjUtFawuumihyVGuk8e-o6iE9OkDf-MX1aKRTqA5U";
const ACCESS_TABLE  = "paid_access";
const USERS_TABLE   = "users_login";

// EmailJS (values taken from your screenshots)
const EMAILJS_PUBLIC_KEY  = "Kvw3qwiz3bt3Xutlf";
const EMAILJS_SERVICE_ID  = "service_o3hfoip";
const EMAILJS_TEMPLATE_ID = "template_0lscxdn";

/* ============================
   INIT
   ============================ */
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// emailjs lib may expose `emailjs` global; init with public key
if (typeof emailjs === "undefined") {
  console.error("EmailJS library not loaded. Check the CDN script.");
}
else {
  try { emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e){ console.warn("emailjs.init failed:", e); }
}

const statusEl = document.getElementById("status");
const emailEl = document.getElementById("emailInput");
const sendBtn = document.getElementById("sendOtpBtn");
const otpStep = document.getElementById("otpStep");
const otpInput = document.getElementById("otpInput");
const verifyBtn = document.getElementById("verifyOtpBtn");
const resendBtn = document.getElementById("resendBtn");
const otpMsg = document.getElementById("otpMsg");
const downloadStep = document.getElementById("downloadStep");
const downloadLink = document.getElementById("downloadLink");
const debugEl = document.getElementById("debug");

if (DEBUG) debugEl.style.display = "block";
downloadLink.href = DOWNLOAD_FILE;

/* session vars */
let currentOtp = null;
let otpExpiry = 0;
let accessRecord = null;
let resendTimer = null;

/* URL params (optional)
   If link contains uid/pass, you can still require the email input.
*/
const qs = new URLSearchParams(location.search);
const urlUid  = qs.get("uid");
const urlPass = qs.get("pass");

/* helpers */
const isEmail = (s)=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
const setStatus = (msg, cls=""){ statusEl.textContent = msg; statusEl.className = cls ? `status ${cls}` : "status"; logDebug(msg); }
function logDebug(...args){ console.log(...args); if(DEBUG) debugEl.textContent += JSON.stringify(args,null,2) + "\n"; }

/* resend countdown */
function startResendCountdown(sec=30){
  resendBtn.disabled = true;
  let left = sec;
  resendBtn.textContent = `Resend (${left}s)`;
  clearInterval(resendTimer);
  resendTimer = setInterval(()=>{
    left--;
    if(left<=0){ clearInterval(resendTimer); resendBtn.disabled = false; resendBtn.textContent = "Resend OTP"; }
    else resendBtn.textContent = `Resend (${left}s)`;
  },1000);
}

/* generate OTP */
function makeOtp(){ return String(Math.floor(100000 + Math.random()*900000)); }

/* ============================
   SEND OTP FLOW
   ============================ */
sendBtn.addEventListener("click", async ()=>{
  const email = emailEl.value.trim().toLowerCase();
  if(!isEmail(email)){ setStatus("Please enter a valid email address.", "error"); return; }

  setStatus("Checking purchaseâ€¦");
  sendBtn.disabled = true;

  try{
    // Query Supabase for an unused access row where uid=email
    let query = supabaseClient.from(ACCESS_TABLE).select("id, uid, password, used").eq("uid", email).eq("used", false).limit(1);

    // If the link provided a pass param, enforce it too
    if(urlPass) query = query.eq("password", urlPass);

    const { data, error } = await query;
    if(error){
      console.error("Supabase query error:", error);
      setStatus("Server error while checking purchase. See console.", "error");
      return;
    }

    if(!data || data.length === 0){
      setStatus("No active purchase found for this email (or it was already used). Use the same email used at purchase.", "error");
      return;
    }

    accessRecord = data[0];
    logDebug("accessRecord:", accessRecord);

    // Create OTP, set expiry
    currentOtp = makeOtp();
    otpExpiry = Date.now() + 15 * 60 * 1000; // 15 minutes

    // Send email via EmailJS
    if(typeof emailjs === "undefined"){
      setStatus("Email sending service not loaded. Contact admin.", "error");
      return;
    }

    setStatus("Sending OTP to your emailâ€¦");
    // template params: ensure your EmailJS template uses {{email}}, {{passcode}}, {{time}}
    const templateParams = {
      email: email,
      passcode: currentOtp,
      time: new Date(otpExpiry).toLocaleString()
    };

    try{
      const resp = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
      // success returns object with status - but many setups return {status:200}
      logDebug("EmailJS response:", resp);
      setStatus("ðŸ“© OTP sent â€” check your email.", "success");
      otpStep.style.display = "block";
      startResendCountdown(30);
    }catch(sendErr){
      console.error("EmailJS send error:", sendErr);
      let errText = (sendErr && sendErr.text) ? sendErr.text : JSON.stringify(sendErr);
      // common EmailJS errors: origin not allowed, template variable missing
      setStatus("Failed to send OTP. Check EmailJS configuration and allowed origin. See console for details.", "error");
      if(DEBUG) otpMsg.textContent = "EmailJS error: " + errText;
      return;
    }

  }catch(e){
    console.error("Unexpected send flow error:", e);
    setStatus("Unexpected error. Check console.", "error");
  }finally{
    sendBtn.disabled = false;
  }
});

/* Resend */
resendBtn.addEventListener("click", async ()=>{
  const email = emailEl.value.trim().toLowerCase();
  if(!isEmail(email)){ otpMsg.textContent = "Enter a valid email to resend"; return; }
  if(!accessRecord){ otpMsg.textContent = "No active purchase; please send OTP first."; return; }

  currentOtp = makeOtp();
  otpExpiry = Date.now() + 15*60*1000;
  try{
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, { email, passcode: currentOtp, time: new Date(otpExpiry).toLocaleString() });
    otpMsg.textContent = "New OTP sent.";
    otpMsg.style.color = "green";
    startResendCountdown(30);
  }catch(e){
    console.error("Resend error:", e);
    otpMsg.textContent = "Resend failed â€” check console.";
    otpMsg.style.color = "#dc2626";
  }
});

/* ============================
   VERIFY OTP
   ============================ */
verifyBtn.addEventListener("click", ()=>{
  const entered = otpInput.value.trim();
  if(!currentOtp){ otpMsg.textContent = "No OTP requested yet."; otpMsg.style.color="#dc2626"; return; }
  if(Date.now() > otpExpiry){ otpMsg.textContent = "OTP expired â€” please resend."; otpMsg.style.color="#dc2626"; return; }
  if(entered === currentOtp){
    otpMsg.textContent = "OTP verified.";
    otpMsg.style.color = "green";
    setStatus("âœ… OTP verified. Download unlocked.", "success");
    downloadStep.style.display = "block";
    otpStep.style.display = "none";
    // prevent changing after success
    verifyBtn.disabled = true;
    otpInput.readOnly = true;
    resendBtn.disabled = true;
  }else{
    otpMsg.textContent = "Invalid OTP â€” check your email.";
    otpMsg.style.color = "#dc2626";
  }
});

/* allow pressing Enter in OTP field */
otpInput.addEventListener("keydown", e => { if(e.key === "Enter") verifyBtn.click(); });

/* ============================
   DOWNLOAD CLICK â€” finalize
   ============================ */
downloadLink.addEventListener("click", async (ev)=>{
  // The actual browser download may be canceled â€” still mark in DB immediately to avoid re-use
  try{
    if(accessRecord && accessRecord.id){
      const { error } = await supabaseClient.from(ACCESS_TABLE)
        .update({ used: true, used_at: new Date().toISOString() })
        .eq("id", accessRecord.id);
      if(error) console.error("Error marking used:", error);
      else logDebug("Marked access used for id", accessRecord.id);
    }

    // optional: remove users_login row (by email uid)
    try{
      const email = emailEl.value.trim().toLowerCase();
      if(email){
        await supabaseClient.from(USERS_TABLE).delete().eq("email", email);
        logDebug("users_login cleanup attempted for", email);
      }
    }catch(e2){ console.warn("users_login cleanup failed:", e2); }

    // disable UI
    downloadLink.textContent = "Downloaded";
    downloadLink.style.pointerEvents = "none";
    setStatus("This link is now used. To get another copy purchase again.", "success");
  }catch(err){
    console.error("Post-download error:", err);
  }
});

/* ============================
   initial status text
   ============================ */
setStatus("Please enter your email to continue. If you used a special link, enter the same email used at purchase.");

</script>
</body>
</html>
